---
import { getCollection, type CollectionEntry } from "astro:content";
import {
  formatFloatingDateTime,
  formatFloatingMonthDay,
  getEasternNow,
  isSameFloatingDay,
  parseFloatingIso,
} from "@/lib/utils/floatingDate";

type EventEntry = CollectionEntry<"events">;

interface Props {
  limit?: number;
  title?: string;
  showCalendarCta?: boolean;
  calendarHref?: string;
  containerClass?: string;
}

const {
  limit = 4,
  title = "Upcoming Events",
  showCalendarCta = true,
  calendarHref = "/calendar/",
  containerClass = "container px-6 max-w-[1400px] mx-auto",
} = Astro.props;

// Load all events from the content collection
const coll: EventEntry[] = await getCollection("events");

// Helpers
const now = getEasternNow();
const parseDate = (v: unknown) => parseFloatingIso(v as string | Date | null | undefined) ?? undefined;

function inFutureOrOngoing(e: EventEntry) {
  const start = parseDate(e.data.date);
  const end = parseDate((e.data as any).endDate);
  if (!start) return false;
  return start >= now || (end && end >= now);
}

function fmtRange(e: EventEntry) {
  const s = parseDate(e.data.date);
  const end = parseDate((e.data as any).endDate);
  if (!s) return "TBD";
  if (!end || isSameFloatingDay(s, end)) {
    return formatFloatingDateTime(s);
  }
  const S = formatFloatingMonthDay(s);
  const E = formatFloatingMonthDay(end);
  return `${S}-${E}`;
}

// Filter, sort, limit
const upcoming = coll
  .filter(inFutureOrOngoing)
  .sort((a, b) => {
    const da = parseDate(a.data.date)?.getTime() ?? 0;
    const db = parseDate(b.data.date)?.getTime() ?? 0;
    return da - db;
  })
  .slice(0, limit);
---

{upcoming.length > 0 && (
  <section>
    <div class={containerClass}>
      <div class="flex items-end justify-between gap-4">
        <h2 class="section-title">{title}</h2>
        {showCalendarCta && (
          <a class="px-3 py-2 rounded-lg border border-white/20 text-white/90" href={calendarHref}>
            View All Upcoming Events
          </a>
        )}
      </div>

      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-4 mt-6">
        {upcoming.map((ev) => {
          const cover = (ev.data as any).cover as string | undefined;
          const location = (ev.data as any).location as string | undefined;
          const summary = (ev.data as any).summary as string | undefined;
          const url = (ev.data as any).url ?? `/${ev.collection}/${ev.slug}/`;
          const rsvpUrl = (ev.data as any).rsvpUrl as string | undefined;
          return (
            <div class="w4-card block">
              {cover && (
                <img
                  src={cover}
                  alt=""
                  class="mb-3 rounded-lg"
                  style="aspect-ratio:16/9;object-fit:cover;"
                />
              )}
              <div class="text-sm text-white/60 mb-1">{fmtRange(ev)}</div>
              <h3 class="text-white font-semibold text-lg leading-snug">{ev.data.title}</h3>
              {location && (
                <p class="mt-1 text-white/80">
                  <strong>Location: </strong> {location}
                </p>
              )}
              {summary && <p class="mt-2 text-white/80">{summary}</p>}
              <div class="mt-3 flex flex-wrap gap-3">
                {rsvpUrl && (
                  <a
                    class="inline-flex items-center gap-1 text-(--w4-accent) font-semibold text-sm underline underline-offset-4"
                    href={rsvpUrl}
                  >
                    RSVP
                  </a>
                )}
                <a
                  class="inline-flex items-center gap-1 text-(--w4-accent) font-semibold text-sm underline underline-offset-4"
                  href={url}
                >
                  More info
                </a>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>
)}
