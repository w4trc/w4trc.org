---
import { getCollection, type CollectionEntry } from "astro:content";

type EventEntry = CollectionEntry<"events">;

interface Props {
  limit?: number;
  title?: string;
  showCalendarCta?: boolean;
  calendarHref?: string;
  containerClass?: string;
}

const {
  limit = 4,
  title = "Upcoming Events",
  showCalendarCta = true,
  calendarHref = "/calendar/",
  containerClass = "container px-6 max-w-[1400px] mx-auto",
} = Astro.props;

// Load all events from the content collection
const coll: EventEntry[] = await getCollection("events");

// Helpers
const now = new Date();
const parseDate = (v: unknown) => {
  // entries may be Date or string depending on schema; normalize to Date
  if (v instanceof Date) return v;
  if (typeof v === "string") {
    const d = new Date(v);
    return isNaN(+d) ? undefined : d;
  }
  return undefined;
};

function inFutureOrOngoing(e: EventEntry) {
  const start = parseDate(e.data.date);
  const end = parseDate((e.data as any).endDate);
  if (!start) return false;
  return start >= now || (end && end >= now);
}

function fmtRange(e: EventEntry) {
  const s = parseDate(e.data.date);
  const end = parseDate((e.data as any).endDate);
  if (!s) return "TBD";
  if (!end || s.toDateString() === end.toDateString()) {
    return s.toLocaleString(undefined, {
      weekday: "short", month: "short", day: "numeric",
      hour: "numeric", minute: "2-digit", timeZoneName: "short",
    });
  }
  const S = s.toLocaleString(undefined, { month: "short", day: "numeric" });
  const E = end.toLocaleString(undefined, { month: "short", day: "numeric" });
  return `${S}–${E}`;
}

// Filter → sort → limit
const upcoming = coll
  .filter(inFutureOrOngoing)
  .sort((a, b) => {
    const da = parseDate(a.data.date)?.getTime() ?? 0;
    const db = parseDate(b.data.date)?.getTime() ?? 0;
    return da - db;
  })
  .slice(0, limit);
---

{upcoming.length > 0 && (
  <section>
    <div class={containerClass}>
      <div class="flex items-end justify-between gap-4">
        <h2 class="section-title">{title}</h2>
        {showCalendarCta && (
          <a class="px-3 py-2 rounded-lg border border-white/20 text-white/90" href={calendarHref}>
            View Calendar
          </a>
        )}
      </div>

      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-4 mt-6">
        {upcoming.map((ev) => {
          const cover = (ev.data as any).cover as string | undefined;
          const location = (ev.data as any).location as string | undefined;
          const summary = (ev.data as any).summary as string | undefined;
          const url = (ev.data as any).url ?? `/${ev.collection}/${ev.slug}/`;
          return (
            <a href={url} class="w4-card block">
              {cover && (
                <img
                  src={cover}
                  alt=""
                  class="mb-3 rounded-lg"
                  style="aspect-ratio:16/9;object-fit:cover;"
                />
              )}
              <div class="text-sm text-white/60 mb-1">{fmtRange(ev)}</div>
              <h3 class="text-white font-semibold text-lg leading-snug">{ev.data.title}</h3>
              {location && (
                <p class="mt-1 text-white/80">
                  <strong>Location:</strong> {location}
                </p>
              )}
              {summary && <p class="mt-2 text-white/80">{summary}</p>}
            </a>
          );
        })}
      </div>
    </div>
  </section>
)}
