---
import ImageMod from "@/components/ImageMod.astro";
import Base from "@/layouts/Base.astro";
import { getListPage } from "@/lib/contentParser.astro";
import { markdownify } from "@/lib/utils/textConverter";
import CallToAction from "@/partials/CallToAction.astro";
import Testimonial from "@/partials/Testimonial.astro";
import { FaCheck } from "react-icons/fa";

// NEW: meetings data + latest posts
import NextMeeting from "@/components/NextMeeting.astro";
import meetings from "@/data/meetings.json";
import Upcoming from "@/layouts/components/Upcoming.astro";
import { getCollection } from "astro:content";

const homepage = await getListPage("homepage", "-index");
const call_to_action = await getListPage("ctaSection", "call-to-action");
const testimonial = await getListPage("testimonialSection", "testimonial");
const { banner, features } = homepage.data;

// NEW: fetch last 3 items across `news` + `blog`
let newsPosts: any[] = [];
try {
  const blog = await getCollection("blog");
  newsPosts = [...blog]
    .sort((a, b) => +new Date(b.data.date) - +new Date(a.data.date))
    .slice(0, 3);
} catch (e) {
  // collections might not exist yet; render nothing gracefully
  newsPosts = [];
}
---

<Base>
  <!-- Banner -->
  <section class="section pt-14">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-7 md:col-9 mb-8 text-center">
          <h1
            set:html={markdownify(banner.title)}
            class="mb-4 text-h3 lg:text-h1"
          />
          <p set:html={markdownify(banner.content)} class="mb-8" />
          {
            banner.button.enable && (
              <a
                class="btn btn-primary"
                href={banner.button.link}
                target={banner.button.link.startsWith("http") ? "_blank" : "_self"}
                rel="noopener"
              >
                {banner.button.label}
              </a>
            )
          }
        </div>
        {
          banner.image && (
            <div class="col-12">
              <ImageMod
                src={banner.image}
                height={380}
                width={1200}
                alt="banner"
                format="webp"
              />
            </div>
          )
        }
      </div>
    </div>
  </section>
  <!-- /Banner -->

  
  <!-- Next Meeting (component) -->
  <NextMeeting meeting={meetings} />

  <!-- Upcoming (auto-loads from content collection or JSON fallback) -->
  <Upcoming limit={4} title="Upcoming Events" showCalendarCta={true} calendarHref="/calendar/" />


  <!-- ===================== -->
  <!-- Quick Links (NEW)    -->
  <!-- ===================== -->
  <section>
    <div class="container px-6 max-w-[1400px] mx-auto">
      <h2 class="section-title">Quick Links</h2>
      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-4 mt-6">
        <a class="quicklink-card" href="/repeaters/">
          <p class="text-lg font-semibold text-white">Club Repeaters</p>
          <p>Frequencies, tones, coverage notes.</p>
        </a>
        <a class="quicklink-card" href="/nets/">
          <p class="text-lg font-semibold text-white">Weekly Nets</p>
          <p>Schedules and scripts.</p>
        </a>
        <a class="quicklink-card" href="/license/">
          <p class="text-lg font-semibold text-white">Get Licensed / Upgrade</p>
          <p>Study materials and test sessions.</p>
        </a>
        <a class="quicklink-card" href="/projects/">
          <p class="text-lg font-semibold text-white">Projects</p>
          <p>Club builds, antennas, mesh.</p>
        </a>
      </div>
    </div>
  </section>

  <!-- ===================== -->
  <!-- Latest News (NEW)    -->
  <!-- ===================== -->
  {newsPosts.length > 0 && (
    <section>
      <div class="container px-6 max-w-[1400px] mx-auto">
        <h2 class="section-title">Latest News</h2>
        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3 mt-6">
          {newsPosts.map((post) => {
            const href = post.slug ? `/${post.collection}/${post.slug}/` : "#";
            const cover = post.data.cover;
            const date = new Date(post.data.date);
            const dateStr = date.toLocaleDateString(undefined, {
              month: "short",
              day: "numeric",
              year: "numeric",
            });
            return (
              <a href={href} class="news-card group">
                {cover && <img src={cover} alt="" class="mb-3" />}
                <div class="text-sm text-white/60 mb-1">{dateStr}</div>
                <h3>{post.data.title}</h3>
                <p>{post.data.summary || ""}</p>
              </a>
            );
          })}
        </div>
      </div>
    </section>
  )}

  <CallToAction call_to_action={call_to_action} />
</Base>
