---
import ImageMod from "@/components/ImageMod.astro";
import Base from "@/layouts/Base.astro";
import { getListPage } from "@/lib/contentParser.astro";
import { markdownify } from "@/lib/utils/textConverter";
import CallToAction from "@/partials/CallToAction.astro";
import Testimonial from "@/partials/Testimonial.astro";
import { FaCheck } from "react-icons/fa";
import hero from "@/config/hero.json";


// NEW: meetings data + latest posts
import NextMeeting from "@/components/NextMeeting.astro";
import meetings from "@/data/meetings.json";
import Upcoming from "@/layouts/components/Upcoming.astro";
import { getCollection } from "astro:content";
import HeroBanner from "@/components/HeroBanner.astro";

const homepage = await getListPage("homepage", "-index");
const call_to_action = await getListPage("ctaSection", "call-to-action");
const testimonial = await getListPage("testimonialSection", "testimonial");

const { banner, features } = homepage.data;

// Raw weather widget markup (kept as-is so the third-party script can bootstrap itself)
const weatherWidgetMarkup = `<a class="weatherwidget-io" href="https://forecast7.com/en/36d55n82d56/kingsport/?unit=us" data-label_1="KINGSPORT" data-label_2="WEATHER" data-theme="pure">KINGSPORT WEATHER</a>
<script>
!function(d,s,id){
  var js,fjs=d.getElementsByTagName(s)[0];
  if(!d.getElementById(id)){
    js=d.createElement(s);
    js.id=id;
    js.src='https://weatherwidget.io/js/widget.min.js';
    fjs.parentNode.insertBefore(js,fjs);
  }
}(document,'script','weatherwidget-io-js');
</script>`;

// NEW: fetch last 3 items across `news` + `blog`
let newsPosts: any[] = [];
try {
  const blog = await getCollection("blog");
  newsPosts = [...blog]
    .sort((a, b) => +new Date(b.data.date) - +new Date(a.data.date))
    .slice(0, 3);
} catch (e) {
  // collections might not exist yet; render nothing gracefully
  newsPosts = [];
}
---

<Base>
  
  <HeroBanner />
  
  <!-- Next Meeting (component) -->
  <NextMeeting meeting={meetings} />

  <!-- Upcoming (auto-loads from content collection or JSON fallback) -->
  <Upcoming limit={4} title="Upcoming Events" showCalendarCta={true} calendarHref="/calendar/" />


  <!-- ===================== -->
  <!-- Quick Links (NEW)    -->
  <!-- ===================== -->
  <section>
    <div class="container px-6 max-w-[1400px] mx-auto">
      <h2 class="section-title">Quick Links</h2>
      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-4 mt-6">
        <a class="quicklink-card" href="/repeaters/">
          <p class="text-lg font-semibold text-white">Club Repeaters</p>
          <p>Frequencies, tones, coverage notes.</p>
        </a>
        <a class="quicklink-card" href="/nets/">
          <p class="text-lg font-semibold text-white">Weekly Nets</p>
          <p>Schedules and scripts.</p>
        </a>
        <a class="quicklink-card" href="/license/">
          <p class="text-lg font-semibold text-white">Get Licensed / Upgrade</p>
          <p>Study materials and test sessions.</p>
        </a>
        <a class="quicklink-card" href="/projects/">
          <p class="text-lg font-semibold text-white">Projects</p>
          <p>Club builds, antennas, mesh.</p>
        </a>
      </div>
    </div>
  </section>

  <!-- ===================== -->
  <!-- Latest News (NEW)    -->
  <!-- ===================== -->
  {newsPosts.length > 0 && (
    <section>
      <div class="container px-6 max-w-[1400px] mx-auto">
        <h2 class="section-title">Latest News</h2>
        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3 mt-6">
          {newsPosts.map((post) => {
            const href = post.slug ? `/${post.collection}/${post.slug}/` : "#";
            const cover = post.data.cover;
            const date = new Date(post.data.date);
            const dateStr = date.toLocaleDateString(undefined, {
              month: "short",
              day: "numeric",
              year: "numeric",
            });
            return (
              <a href={href} class="news-card group">
                {cover && <img src={cover} alt="" class="mb-3" />}
                <div class="text-sm text-white/60 mb-1">{dateStr}</div>
                <h3>{post.data.title}</h3>
                <p>{post.data.summary || ""}</p>
              </a>
            );
          })}
        </div>
      </div>
    </section>
  )}

  <!-- ===================== -->
  <!-- Conditions (Solar + Weather) -->
  <!-- ===================== -->
  <section>
    <div class="container px-6 max-w-[1400px] mx-auto">
      <h2 class="section-title">Conditions</h2>
      <div class="grid gap-8 lg:grid-cols-2 mt-6 items-start">
        <div class="rounded-2xl border border-border dark:border-darkmode-border bg-white/5 dark:bg-darkmode-light/20 p-6 text-center">
          <a href="https://www.hamqsl.com/solar.html" class="inline-block" title="Solar-Terrestrial Data from N0NBH">
            <img src="https://www.hamqsl.com/solar101pic.php" alt="Solar-Terrestrial data panel" class="mx-auto" loading="lazy" />
          </a>
          <p class="mt-4 text-sm text-text-light dark:text-darkmode-text-light">
            Solar Weather provided by <a href="https://www.hamqsl.com/solar.html" class="underline">N0NBH</a>.{" "}
            <a href="https://www.hamqsl.com/solar2.html#glossary" class="underline">What do these numbers mean?</a>
          </p>
        </div>
        <div class="rounded-2xl border border-border dark:border-darkmode-border bg-white/5 dark:bg-darkmode-light/20 p-6 text-center">
          <div set:html={weatherWidgetMarkup}></div>
        </div>
      </div>
    </div>
  </section>


</Base>
