{{ define "main" }}
{{- $now := now -}}

{{/* Grab all event pages in this section */}}
{{- $all := where .Pages "Draft" false -}}

{{/* Build normalized structs: { page, start, end, img } */}}
{{- $norm := slice -}}
{{- range $all }}
  {{- $start := .Date -}}
  {{- with .Params.startDate }}{{- $start = time (printf "%v" .) -}}{{- end -}}
  {{- $end := $start -}}
  {{- with .Params.endDate }}{{- $end = time (printf "%v" .) -}}{{- end -}}

  {{- $img := "" -}}
  {{- with .Params.image }}{{- $img = . -}}{{- end -}}
  {{- if not $img }}{{- with .Resources.GetMatch "cover*" }}{{- $img = .RelPermalink -}}{{- end }}{{- end -}}

  {{- $norm = $norm | append (dict "page" . "start" $start "end" $end "img" $img) -}}
{{- end -}}

{{- $upcoming := where $norm "end" "ge" $now | sort "start" "asc" -}}
{{- $past     := where $norm "end" "lt" $now  | sort "start" "desc" -}}

<section class="mt-8">
  <div class="max-w-[1400px] mx-auto px-6">
    <h1 class="section-title">Events</h1>

    {{- if gt (len $upcoming) 0 }}
      <h2 class="text-white text-xl mt-8">Upcoming</h2>
      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3 mt-4">
        {{- range $upcoming }}
          {{- $p := .page }} {{- $s := .start }} {{- $e := .end }} {{- $img := .img -}}
          {{- $sameDay := eq (time.Format "2006-01-02" $s) (time.Format "2006-01-02" $e) -}}
          {{- $dateLine := cond $sameDay
              (printf "%s, %s, %s–%s" (time.Format "Mon" $s) (time.Format "Jan 2" $s) (time.Format "3:04 PM" $s) (time.Format "3:04 PM" $e))
              (printf "%s – %s" (time.Format "Jan 2, 3:04 PM" $s) (time.Format "Jan 2, 3:04 PM" $e))
          -}}
          <a href="{{ $p.RelPermalink }}" class="news-card group">
            {{- with $img }}<img src="{{ . | relURL }}" alt="" class="mb-3">{{- end }}
            <div class="text-sm text-white/60 mb-1">{{ $dateLine }}</div>
            <h3 class="text-white">{{ $p.Title }}</h3>
            {{- with $p.Params.location }}<p class="text-white/80 mt-1"><strong>Location:</strong> {{ . }}</p>{{- end }}
            {{- if $p.Params.summary }}<p class="text-white/80 mt-2">{{ $p.Params.summary }}</p>{{- else }}{{- with $p.Summary }}<p class="text-white/80 mt-2">{{ . | plainify }}</p>{{- end }}{{- end }}
          </a>
        {{- end }}
      </div>
    {{- end }}

    {{- if gt (len $past) 0 }}
      <h2 class="text-white text-xl mt-10">Past</h2>
      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3 mt-4">
        {{- range $past }}
          {{- $p := .page }} {{- $s := .start }} {{- $e := .end }} {{- $img := .img -}}
          {{- $sameDay := eq (time.Format "2006-01-02" $s) (time.Format "2006-01-02" $e) -}}
          {{- $dateLine := cond $sameDay
              (printf "%s, %s, %s–%s" (time.Format "Mon" $s) (time.Format "Jan 2" $s) (time.Format "3:04 PM" $s) (time.Format "3:04 PM" $e))
              (printf "%s – %s" (time.Format "Jan 2, 3:04 PM" $s) (time.Format "Jan 2, 3:04 PM" $e))
          -}}
          <a href="{{ $p.RelPermalink }}" class="news-card group opacity-80 hover:opacity-100">
            {{- with $img }}<img src="{{ . | relURL }}" alt="" class="mb-3">{{- end }}
            <div class="text-sm text-white/60 mb-1">{{ $dateLine }}</div>
            <h3 class="text-white">{{ $p.Title }}</h3>
            {{- with $p.Params.location }}<p class="text-white/80 mt-1"><strong>Location:</strong> {{ . }}</p>{{- end }}
            {{- with $p.Params.summary }}<p class="text-white/80 mt-2">{{ . }}</p>{{- end }}
          </a>
        {{- end }}
      </div>
    {{- end }}
  </div>
</section>
{{ end }}