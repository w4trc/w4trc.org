{{/* layouts/partials/upcoming.html — robust startDate/endDate handling */}}
{{- $now := now -}}

{{/* Gather event pages in any language; then filter */}}
{{- $pages := where site.Pages "Section" "events" -}}
{{- $pages = where $pages "Draft" false -}}
{{- $pages = where $pages ".Params.showOnHome" true -}}

{{- $eligible := slice -}}
{{- range $pages }}
  {{- /* Parse start/end safely */ -}}
  {{- $hasStart := and (isset .Params "startDate") (ne .Params.startDate "") -}}
  {{- $hasEnd   := and (isset .Params "endDate")   (ne .Params.endDate   "") -}}

  {{- $start := .Date -}}
  {{- if $hasStart }}{{- $start = time .Params.startDate -}}{{- end -}}

  {{- $end := $start -}}
  {{- if $hasEnd }}{{- $end = time .Params.endDate -}}{{- end -}}

  {{- /* Include if it hasn’t happened yet: either start in future OR end in future */ -}}
  {{- if or (ge $start $now) (ge $end $now) -}}
    {{- $eligible = $eligible | append (dict "page" . "start" $start "end" $end) -}}
  {{- end -}}
{{- end -}}

{{- $upcoming := first 2 (sort $eligible "start" "asc") -}}

{{- if gt (len $upcoming) 0 }}
<section>
  <div class="max-w-[1400px] mx-auto px-6">
    <h2 class="section-title">Upcoming Events</h2>
    <div class="grid gap-6 md:grid-cols-2 mt-6">
      {{- range $upcoming }}
        {{- $p := .page -}}
        {{- $s := .start -}}
        {{- $e := .end -}}
        {{- $sameDay := eq (time.Format "2006-01-02" $s) (time.Format "2006-01-02" $e) -}}
        {{- $dateLine := cond $sameDay
            (printf "%s, %s, %s–%s" (time.Format "Mon" $s) (time.Format "Jan 2" $s) (time.Format "3:04 PM" $s) (time.Format "3:04 PM" $e))
            (printf "%s – %s"      (time.Format "Jan 2, 3:04 PM" $s) (time.Format "Jan 2, 3:04 PM" $e))
        -}}

        {{- $img := "" -}}
        {{- with $p.Params.image }}{{- $img = . -}}{{- end -}}
        {{- if not $img }}{{- with $p.Resources.GetMatch "cover*" }}{{- $img = .RelPermalink -}}{{- end }}{{- end -}}

        <article class="news-card group">
          {{- with $img }}<img src="{{ . | relURL }}" alt="" class="mb-3">{{- end }}
          <div class="text-sm text-white/60 mb-1">{{ $dateLine }}</div>
          <h3 class="text-white"><a href="{{ $p.RelPermalink }}" class="hover:underline">{{ $p.Title }}</a></h3>
          {{- with $p.Params.location }}<p class="text-white/80 mt-1"><strong>Location:</strong> {{ . }}</p>{{- end }}
          {{- if $p.Params.summary }}<p class="text-white/80 mt-2">{{ $p.Params.summary }}</p>{{- else }}{{- with $p.Summary }}<p class="text-white/80 mt-2">{{ . | plainify }}</p>{{- end }}{{- end }}
          <div class="mt-4"><a href="{{ $p.RelPermalink }}" class="inline-block px-4 py-2 rounded-xl border border-white/20 text-white/90 hover:bg-white/10">More info</a></div>
        </article>
      {{- end }}
    </div>
  </div>
</section>
{{- end }}
